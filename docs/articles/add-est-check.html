<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="estimability">
<title>How to add estimability checking to your model's `predict` method • estimability</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How to add estimability checking to your model's `predict` method">
<meta property="og:description" content="estimability">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">estimability</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.5.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/add-est-check.html">How to add estimability checking to your model's `predict` method</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rvlenth/estimability/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>How to add estimability checking to your model's `predict` method</h1>
                        <h4 data-toc-skip class="author">estimability
package, Version 1.5.1</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rvlenth/estimability/blob/HEAD/vignettes/add-est-check.Rmd" class="external-link"><code>vignettes/add-est-check.Rmd</code></a></small>
      <div class="d-none name"><code>add-est-check.Rmd</code></div>
    </div>

    
    
<p>The goal of this short vignette is to show how you can easily add
estimability checking to your package’s <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> methods.
Suppose that you have developed a model class that has elements
<code>$coefficients</code>, <code>$formula</code>, etc. Suppose it also
has an <code>$env</code> element, an environment that can hold
miscellaneous information. This is not absolutely necessary, but handy
if it exists. Your model class involves some kind of linear
predictor.</p>
<p>We are concerned with models that:</p>
<ul>
<li>Allow rank deficiencies (where some predictors may be excluded)</li>
<li>Allow predictions for new data</li>
</ul>
<p>For any such model, it is important to add estimability checking to
your predict method, because the regression coefficients are not unique
– and hence that predictions may not be unique. It can be shown that
predictions on new data are unique only for cases that fall within the
row space of the model matrix. The <strong>estimability</strong> package
is designed to check for this.</p>
<p>The recommended design for accommodating rank-deficient models is to
follow the example of <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">stats::lm</a></code> objects, where any
predictors that are excluded have a corresponding regression coefficient
of <code>NA</code>. Please note that this <code>NA</code> code actually
doesn’t actually means the coefficient is missing; it is a code that
means that that coefficient has been constrained to be zero. In what
follows, we assume that this convention is used.</p>
<p>First note that estimability checking is not needed unless you are
predicting for new data. So that’s where you need to incorporate
estimability checking. The <code>predict</code> method should be coded
something like this:</p>
<pre><code><span><span class="va">predict.mymod</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># ... some setup code ...</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html" class="external-link">missing</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">X</span> <span class="op">&lt;-</span>  <span class="co"># ... code to set up the model matrix for newdata ...</span></span>
<span>        </span>
<span>        <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>  <span class="co"># we have rank deficiency so test estimability</span></span>
<span>            <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span> <span class="op">(</span><span class="va">nbasis</span> <span class="op">&lt;-</span> <span class="va">object</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">nbasis</span><span class="op">)</span><span class="op">)</span></span>
<span>                <span class="va">nbasis</span> <span class="op">&lt;-</span> <span class="va">object</span><span class="op">$</span><span class="va">nbasis</span> <span class="op">&lt;-</span></span>
<span>                    <span class="fu">estimability</span><span class="fu">::</span><span class="fu"><a href="../reference/nonest.basis.html">nonest.basis</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span><span class="op">)</span></span>
<span>            <span class="va">b</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>            <span class="va">pred</span> <span class="op">&lt;-</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b</span></span>
<span>            <span class="va">pred</span><span class="op">[</span><span class="op">!</span><span class="fu">estimability</span><span class="fu">::</span><span class="fu"><a href="../reference/nonest.basis.html">is.estble</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">nbasis</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>        <span class="op">}</span></span>
<span>        <span class="kw">else</span></span>
<span>            <span class="va">pred</span> <span class="op">&lt;-</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="co"># ... perhaps more code ...</span></span>
<span>    <span class="va">pred</span></span>
<span><span class="op">}</span></span></code></pre>
<p>That’s it – and this is the fancy version, where we can save
<code>nbasis</code> for use with possible future predictions. Any
non-estimable cases are flagged as <code>NA</code> in the
<code>pred</code> vector.</p>
<p>An alternative way to code this would be to exclude the columns of
<code>X</code> and elements of <code>b</code> that correspond to
<code>NA</code>s in <code>b</code>. But be careful, because you need
<em>all</em> the columns in <code>X</code> in order to check
estimability.</p>
<p>The only other thing you need to do is add <code>estimability</code>
to the <code>Imports</code> list in your `Description file.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Russell Lenth.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
